<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë™ì•„ë¦¬ ë¸”ë¡œê·¸ â€” Realtime DB ë²„ì „(ì •ë¦¬ë³¸)</title>
  <style>
    :root{--bg:#0b1020;--panel:#141a34;--muted:#93a0cf;--text:#e8edff;--ok:#28d17c;--bad:#ff6b6b}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans KR",sans-serif;background:#0b1020;color:var(--text)}
    header{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#141a34;border-bottom:1px solid #2a346a}
    .btn{padding:10px 14px;border:1px solid #3a4588;background:#1a2253;color:#fff;border-radius:12px;cursor:pointer}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    .card{background:#121739;border:1px solid #26306b;border-radius:16px;padding:18px;margin:16px 0}
    input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #34407d;background:#0d1330;color:#e8edff;margin:6px 0}
    textarea{min-height:90px;resize:vertical}
    [hidden]{display:none!important}
    .post{padding:14px;border-radius:12px;background:#0f1535;border:1px solid #2a356e;margin:12px 0}
    .post img{max-width:100%;border-radius:10px;border:1px solid #2b3a7b}
    .meta{font-size:14px;color:#b9c9ff;margin-bottom:6px}
    .hint{color:var(--muted);font-size:12px}
    .ok{color:var(--ok)} .err{color:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div>ğŸš€ ë™ì•„ë¦¬ ë¸”ë¡œê·¸ (Realtime Database)</div>
    <div>
      <span id="greet" class="hint" hidden></span>
      <button id="btnLogout" class="btn" hidden>ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <main class="wrap">
    <!-- íšŒì›ê°€ì… -->
    <section id="page-signup" class="card">
      <h3>íšŒì›ê°€ì…</h3>
      <input id="su_name" type="text" placeholder="ì´ë¦„" required />
      <input id="su_email" type="email" placeholder="ì´ë©”ì¼" required />
      <input id="su_pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì ì´ìƒ)" minlength="6" required />
      <label class="hint">í”„ë¡œí•„ ì´ë¯¸ì§€(ì„ íƒ)</label>
      <input id="su_avatar" type="file" accept="image/*" />
      <div id="signupMsg" class="hint"></div>
      <button id="btnSignup" class="btn" type="button">ê°€ì…í•˜ê¸°</button>
      <div class="hint" style="margin-top:8px">
        ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”?
        <button id="goLogin" class="btn" type="button" style="padding:6px 10px">ë¡œê·¸ì¸</button>
      </div>
    </section>

    <!-- ë¡œê·¸ì¸ -->
    <section id="page-login" class="card" hidden>
      <h3>ë¡œê·¸ì¸</h3>
      <input id="li_email" type="email" placeholder="ì´ë©”ì¼" required />
      <input id="li_pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required />
      <div id="loginMsg" class="hint"></div>
      <button id="btnLogin" class="btn" type="button">ë¡œê·¸ì¸</button>
    </section>

    <!-- ë©”ì¸ -->
    <section id="page-main" hidden>
      <div class="card">
        <h3>ìƒˆ ê¸€ ì“°ê¸°</h3>
        <textarea id="po_text" placeholder="ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”?"></textarea>
        <label class="hint">ì‚¬ì§„(ì„ íƒ)</label>
        <input id="po_img" type="file" accept="image/*" />
        <button id="btnPost" class="btn" type="button">ê²Œì‹œ</button>
        <span id="postMsg" class="hint"></span>
      </div>

      <div class="card">
        <h3>í”¼ë“œ</h3>
        <div id="feed"></div>
        <div id="empty" class="hint">ì•„ì§ ê¸€ì´ ì—†ì–´ìš”.</div>
      </div>
    </section>
  </main>

  <script type="module">
    // --- Firebase SDK (App/Auth/Realtime DB/Storage) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      updateProfile,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      remove,
      get
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
    
    import {
      getStorage,
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

    // ğŸ”‘ ë„¤ í”„ë¡œì íŠ¸ ê°’ (databaseURL ê¼­ í¬í•¨!)
    const firebaseConfig = {
      apiKey: "AIzaSyDH5rYNy8JmYunswXvuWiCTO7vyebCohpk",
      authDomain: "blog-c678b.firebaseapp.com",
      databaseURL: "https://blog-c678b-default-rtdb.firebaseio.com",
      projectId: "blog-c678b",
      storageBucket: "blog-c678b.appspot.com",
      messagingSenderId: "474253780071",
      appId: "1:474253780071:web:321d84de40ec9b384f20c2",
      measurementId: "G-RQ3ZBT73QS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // --- DOM ---
    const $ = sel => document.querySelector(sel);
    const pageSignup = $('#page-signup');
    const pageLogin  = $('#page-login');
    const pageMain   = $('#page-main');
    const greet      = $('#greet');
    const btnLogout  = $('#btnLogout');
    const feed       = $('#feed');
    const empty      = $('#empty');

    const show = (el) => {
      [pageSignup, pageLogin, pageMain].forEach(s => s.hidden = true);
      el.hidden = false;
    };
    const esc = (s='') =>
      s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    // --- Auth state (ì—¬ê¸°ì„œ í•­ìƒ ì´ë¦„ ì„¸íŒ…) ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // DBì— ì €ì¥ëœ ì´ë¦„ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©
        let name = user.displayName || 'ì‚¬ìš©ì';
        try {
          const userSnap = await get(ref(db, `users/${user.uid}`));
          if (userSnap.exists() && userSnap.val().name) {
            name = userSnap.val().name;
          }
        } catch (e) {
          console.warn('user profile read error:', e);
        }

        greet.hidden = false;
        greet.textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${name}ë‹˜!`;
        btnLogout.hidden = false;
        show(pageMain);
        attachFeed();
      } else {
        greet.hidden = true;
        btnLogout.hidden = true;
        show(pageSignup);
        detachFeed();
      }
    });

    // --- íšŒì›ê°€ì… ---
    $('#btnSignup').onclick = async () => {
      const name  = $('#su_name').value.trim();
      const email = $('#su_email').value.trim();
      const pw    = $('#su_pw').value;
      const file  = $('#su_avatar').files[0];
      const msg   = $('#signupMsg');
      msg.textContent = '';

      if (!email || !pw) {
        msg.innerHTML = '<span class="err">ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</span>';
        return;
      }

      try {
        const { user } = await createUserWithEmailAndPassword(auth, email, pw);

        let photoURL = '';
        if (file) {
          const r = sRef(storage, `avatars/${user.uid}/${crypto.randomUUID()}`);
          await uploadBytes(r, file);
          photoURL = await getDownloadURL(r);
        }

        const finalName = name || 'ì‚¬ìš©ì';

        await updateProfile(user, {
          displayName: finalName,
          photoURL: photoURL || null
        });

        await set(ref(db, `users/${user.uid}`), {
          uid: user.uid,
          name: finalName,
          email,
          photoURL: photoURL || '',
          createdAt: Date.now()
        });

        // í—¤ë”ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        greet.hidden = false;
        greet.textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${finalName}ë‹˜!`;
        btnLogout.hidden = false;
        show(pageMain);
        msg.innerHTML = '<span class="ok">ê°€ì… ì„±ê³µ! ì´ì œ ê¸€ì„ ì“¸ ìˆ˜ ìˆì–´ìš”.</span>';
      } catch (e) {
        console.error(e);
        msg.innerHTML = `<span class="err">${esc(e.message || 'ê°€ì… ì‹¤íŒ¨')}</span>`;
      }
    };

    // --- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ---
    $('#goLogin').onclick = () => show(pageLogin);

    $('#btnLogin').onclick = async () => {
      const email = $('#li_email').value.trim();
      const pw    = $('#li_pw').value;
      const msg   = $('#loginMsg');
      msg.textContent = '';
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch (e) {
        console.error(e);
        msg.innerHTML = `<span class="err">${esc(e.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨')}</span>`;
      }
    };

    btnLogout.onclick = () => signOut(auth);

    // --- ìƒˆ ê¸€ ì‘ì„± ---
    // --- Create Post (Realtime DB, BASE64 ì´ë¯¸ì§€) ---
$('#btnPost').onclick = async () => {
  const me = auth.currentUser;
  if (!me) return alert("ë¡œê·¸ì¸ í•„ìš”!");

  const text = $('#po_text').value.trim();
  const file = $('#po_img').files[0];
  const pm = $('#postMsg');
  pm.textContent = '';

  if (!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

  let imageBase64 = "";

  try {
    // ğŸ”¥ ì´ë¯¸ì§€ ì„ íƒëœ ê²½ìš° BASE64 ë³€í™˜
    if (file) {
      const reader = new FileReader();
      imageBase64 = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject("ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨");
        reader.readAsDataURL(file);
      });
    }

    // ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const userName =
      me.displayName ||
      localStorage.getItem("blogName") ||
      "ì‚¬ìš©ì";

    // ğŸ”¥ DBì— ì €ì¥
    const postRef = push(ref(db, "posts"));
    await set(postRef, {
      id: postRef.key,
      uid: me.uid,
      userName,
      userPhoto: me.photoURL || "",
      text,
      imageBase64,
      ts: Date.now(),
      likes: {}
    });

    // ë¦¬ì…‹
    $('#po_text').value = "";
    $('#po_img').value = "";
    pm.innerHTML = `<span class="ok">ê²Œì‹œ ì™„ë£Œ!</span>`;
    setTimeout(() => (pm.textContent = ""), 1500);

  } catch (e) {
    console.error("ğŸ”¥ POST ERROR:", e);
    pm.innerHTML = `<span class="err">${e.message || "ì—…ë¡œë“œ ì‹¤íŒ¨"}</span>`;
  }
};

    // --- í”¼ë“œ ë Œë”ë§ ---
    let unsubscribe = null;

    function attachFeed() {
      if (unsubscribe) return;
      const postsRef = ref(db, 'posts');
      unsubscribe = onValue(postsRef, (snap) => {
        const data = snap.val() || {};
        const list = Object.values(data).sort((a, b) => (b.ts || 0) - (a.ts || 0));
        empty.hidden = list.length > 0;

        feed.innerHTML = list.map(p => `
          <article class="post" data-id="${p.id}">
            <div class="meta">
              ğŸ§‘ <b>${esc(p.userName || 'ì‚¬ìš©ì')}</b>
              Â· <span class="hint">${timeAgo(p.ts)}</span>
            </div>
            <div>${esc(p.text || '')}</div>
            ${p.imageBase64 ? `<img src="${p.imageBase64}" alt="post image" />` : ``}
            <div style="margin-top:8px">
              <button class="btn btn-like" type="button" data-id="${p.id}">
                ${isLiked(p) ? 'ğŸ’–' : 'â¤ï¸'} ${likeCount(p)}
              </button>
              <button class="btn btn-del" type="button" data-id="${p.id}">
                ì‚­ì œ
              </button>
            </div>
          </article>
        `).join('');
      });
    }

    function detachFeed() {
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
      feed.innerHTML = '';
      empty.hidden = false;
    }

    // --- ì¢‹ì•„ìš”/ì‚­ì œ helper ---
    const likeCount = p => p.likes ? Object.keys(p.likes).length : 0;
    const isLiked = p => {
      const u = auth.currentUser;
      return !!(u && p.likes && p.likes[u.uid]);
    };

    function timeAgo(ts) {
      if (!ts) return '';
      const diff = Date.now() - ts;
      const m = 60e3, h = 3600e3, d = 86400e3;
      if (diff < m)  return 'ë°©ê¸ˆ ì „';
      if (diff < h)  return Math.floor(diff / m) + 'ë¶„ ì „';
      if (diff < d)  return Math.floor(diff / h) + 'ì‹œê°„ ì „';
      return Math.floor(diff / d) + 'ì¼ ì „';
    }

    // --- ì¢‹ì•„ìš” í† ê¸€ ---
    async function toggleLike(id) {
      const me = auth.currentUser;
      if (!me) return alert('ë¡œê·¸ì¸ í•„ìš”');

      const likesRef = ref(db, `posts/${id}/likes/${me.uid}`);
      const snap = await get(likesRef);
      if (snap.exists()) {
        await remove(likesRef);      // ì´ë¯¸ ëˆŒë €ìœ¼ë©´ ì·¨ì†Œ
      } else {
        await set(likesRef, true);   // ì•ˆ ëˆŒë €ìœ¼ë©´ ì¶”ê°€
      }
    }

    // --- ê¸€ ì‚­ì œ ---
    async function delPost(id) {
      const me = auth.currentUser;
      if (!me) return alert('ë¡œê·¸ì¸ í•„ìš”');

      const postRef = ref(db, `posts/${id}`);
      const snap = await get(postRef);
      if (!snap.exists()) return;

      const post = snap.val();
      if (post.uid !== me.uid) {
        return alert('ë³¸ì¸ ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.');
      }
      await remove(postRef);
    }

    // --- í”¼ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ (ìœ„ì„) ---
    feed.addEventListener('click', (e) => {
      const likeBtn = e.target.closest('.btn-like');
      const delBtn  = e.target.closest('.btn-del');
      if (likeBtn) toggleLike(likeBtn.dataset.id);
      if (delBtn)  delPost(delBtn.dataset.id);
    });
  </script>
</body>
</html>
